apiVersion: v1
kind: Service
metadata:
  name: dashboard
spec:
  type: ClusterIP
  selector:
    app: dashboard
  ports:
    - protocol: TCP
      port: 8080
      targetPort: 80
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: dashboard
spec:
  replicas: 1
  selector:
    matchLabels:
      app: dashboard
  template:
    metadata:
      labels:
        app: dashboard
    spec:
      initContainers:
        - name: wait-for-state-manager
          image: busybox:1.28
          env:
            - name: STATE_MANAGER_PORT
              valueFrom:
                configMapKeyRef:
                  name: digital-twin-config
                  key: STATE_MANAGER_PORT
          command: ['sh', '-c', 'until nc -z state-manager $STATE_MANAGER_PORT; do echo waiting for state-manager; sleep 2; done;']
        - name: wait-for-notification-manager
          image: busybox:1.28
          env:
            - name: NOTIFICATION_MANAGER_PORT
              valueFrom:
                configMapKeyRef:
                  name: digital-twin-config
                  key: NOTIFICATION_MANAGER_PORT
          command: ['sh', '-c', 'until nc -z notification-manager $NOTIFICATION_MANAGER_PORT; do echo waiting for notification-manager; sleep 2; done;']
      containers:
        - name: dashboard
          image: digital-twin/dashboard:latest
          imagePullPolicy: Never
          ports:
            - containerPort: 80
          # Note: Vite vars are usually build-time.
          # For runtime config in Docker, we typically strictly rely on the build args or a runtime replacement script.
          # The Dockerfile likely uses build args.
          # If the user builds the image as per instructions, they should bake these in.
          # Here we can't easily change VITE_ vars at runtime unless the entrypoint supports it.
          # We'll assume the image is built with defaults or the user follows the plan to build it.
          # However, to be helpful, if the Dockerfile supports ENV override (some setups do), we provide them.
          env:
            - name: VITE_STATE_MANAGER_API_URL
              value: "http://localhost:3000"
            - name: VITE_STATE_MANAGER_WS_URL
              value: "ws://localhost:3001"
            - name: VITE_NOTIFICATION_MANAGER_API_URL
              value: "http://localhost:3002/api"
